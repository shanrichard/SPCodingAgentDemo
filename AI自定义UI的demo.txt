

â€œè®© Claude Code æ”¾å¼€æ‰‹è„šå¹²æ´»â€çš„æ–¹å¼åš demoï¼Œå…³é”®ä¸åœ¨äºé¢„ç½®å¤šå°‘ç»„ä»¶ï¼Œè€Œåœ¨äºæŠŠå®ƒçš„â€œåŠ¨ä½œç©ºé—´â€è®¾è®¡æˆ**é€šç”¨çš„ã€å¯ç»„åˆçš„åŸè¯­**ï¼š

- **æ•°æ®åŸè¯­**ï¼šå®æ—¶è®¢é˜… / å–æ¶ˆè®¢é˜…ä»»æ„ Deribit å…¬å…±é¢‘é“ï¼ˆticker / book / trades / chart ç­‰ï¼‰

- **UI åŸè¯­**ï¼šç»Ÿä¸€çš„ Widget æ¨¡æ¿ï¼ˆReact + Tailwindï¼‰ï¼Œå…è®¸å®ƒè‡ªç”±æ–°å¢é¡µé¢ç»“æ„ã€çŠ¶æ€ç®¡ç†ã€å›¾è¡¨/è¡¨æ ¼å‘ˆç°

- **äº¤ä»˜åŸè¯­**ï¼šä¸€é”®ç”Ÿæˆ â†’ æ„å»º â†’ æŠŠäº§ç‰©æŒ‚åˆ° `/widgets/<id>/`ï¼Œç”± demo é¡µç”¨ `iframe` åŠ è½½

ä½ è¦æ±‚â€œå¿…é¡»å®æ—¶æ•°æ®â€ï¼Œé‚£å°±æŠŠæ•°æ®é“¾è·¯åšæˆ**å¸¸é©» WebSocket ç½‘å…³**ï¼ˆåç«¯å•è¿æ¥æ‰‡å‡ºï¼‰ï¼ŒWidget åœ¨æµè§ˆå™¨é‡Œé€šè¿‡ä½ è‡ªå·±çš„ `/ws/market` æ¥è®¢é˜…å®æ—¶æ•°æ®å³å¯ï¼Œä¸éœ€è¦ replayã€‚Deribit è¿™è¾¹å»ºè®®ç›´æ¥ç”¨ Event Nodes çš„ websocket endpointï¼ˆprod/test ä¸åŒï¼‰ã€‚([support.deribit.com](https://support.deribit.com/hc/en-us/articles/25944778794269-12-December-2023 "12 December 2023 â€“ Deribit Support"))

ä¸‹é¢ç»™ä½ ä¸€ä¸ª**å¯ç›´æ¥è½åœ°çš„ docker-compose æ–¹æ¡ˆ**ï¼ˆ3 ä¸ªæœåŠ¡ï¼š`api` + `builder` + `mcp`ï¼‰ï¼Œä½ æŒ‰ç›®å½•æŠŠæ–‡ä»¶æ”¾å¥½ï¼Œå¡« `.env`ï¼Œ`docker-compose up --build` å°±èƒ½è·‘ã€‚

---

## 1) æ€»ä½“æ¶æ„ï¼ˆæ»¡è¶³â€œå®æ—¶ + æ”¾å¼€æ‰‹è„š + iframe å±•ç¤ºâ€ï¼‰

**è¿è¡Œæ€ï¼ˆç»™é”€å”®çœ‹ï¼‰**

- æµè§ˆå™¨æ‰“å¼€ `http://localhost:8080/`ï¼ˆdemo é¡µï¼‰

- demo é¡µè¾“å…¥è‡ªç„¶è¯­è¨€éœ€æ±‚ â†’ `POST /api/widgets`

- demo é¡µæ‹¿åˆ° `widget_url` â†’ ç”¨ `iframe` ç›´æ¥åŠ è½½ widget

- widget åœ¨ iframe å†…é€šè¿‡ `ws(s)://<host>/ws/market` è®¢é˜… Deribit å®æ—¶é¢‘é“ï¼ˆticker/book/trades/...ï¼‰ï¼Œå®æ—¶åˆ·æ–° UI

**æ„å»ºæ€ï¼ˆClaude Code å¹²æ´»ï¼‰**

- `api` ç”Ÿæˆ widget_idã€å†™å…¥ specï¼Œå¹¶è°ƒç”¨ `builder` æœåŠ¡

- `builder` æŠŠ widget æ¨¡æ¿å¤åˆ¶åˆ° workspace

- `builder` è°ƒ `claude -p ...`ï¼ˆheadlessï¼‰è®©å®ƒæ”¹ä»£ç å¹¶è¿è¡Œæ„å»ºå‘½ä»¤  
  Claude Code çš„ CI ç”¨æ³•é‡Œæ˜ç¡®æ”¯æŒ `--permission-mode acceptEdits`ã€`--allowedTools "Bash(*) Read(*) Edit(*) Write(*) ..."`ï¼Œå¹¶é€šè¿‡ç¯å¢ƒå˜é‡ä½¿ç”¨ `ANTHROPIC_API_KEY`ã€‚([Claude Code](https://code.claude.com/docs/en/gitlab-ci-cd "Claude Code GitLab CI/CD - Claude Code Docs"))

- æ„å»ºäº§ç‰©è¾“å‡ºåˆ°å…±äº«å· `/data/widgets/<id>/dist`

- `api` å°† `/widgets/<id>/` é™æ€æŒ‚è½½ç»™ iframe

**å·¥å…·æ€ï¼ˆç»™ Claude Codeâ€œæŠ€èƒ½/Skillâ€ï¼‰**

- `mcp` æä¾› MCP å·¥å…·ï¼šåˆ—å‡ºå¯ç”¨ instrumentã€ç”Ÿæˆé¢‘é“å­—ç¬¦ä¸²ã€è¿”å›é¢‘é“å‚æ•°é€ŸæŸ¥ï¼ˆticker/book/trades çš„ interval/group/depth è§„åˆ™ç­‰ï¼‰

- Claude Code é€šè¿‡ `claude mcp add --transport http ...` è¿æ¥è¿œç¨‹ MCP æœåŠ¡ï¼ˆå®˜æ–¹æ–‡æ¡£è¯­æ³•ï¼‰ã€‚([Claude Code](https://code.claude.com/docs/en/mcp "Connect Claude Code to tools via MCP - Claude Code Docs"))

---

## 2) å…³é”®å®ç°ç‚¹ï¼ˆä½ æœ€å…³å¿ƒçš„â€œå®æ—¶æ•°æ® + Deribitâ€ï¼‰

### 2.1 Deribit WebSocket endpointï¼ˆEvent Nodesï¼‰

Deribit å®˜æ–¹æ”¯æŒæ–‡ç« æåˆ°ï¼šå…¬å…±è®¢é˜…å°†åªé€šè¿‡ Event Nodes å¯ç”¨ï¼Œprod/test çš„ websocket endpoint éœ€è¦åˆ‡æ¢ï¼š

- testï¼š`wss://test.deribit.com/den/ws`

- prodï¼š`wss://streams.deribit.com/ws/api/v2` ([support.deribit.com](https://support.deribit.com/hc/en-us/articles/25944778794269-12-December-2023 "12 December 2023 â€“ Deribit Support"))

> æ‰€ä»¥æˆ‘ä»¬åœ¨ `api` é‡Œç”¨ç¯å¢ƒå˜é‡ `DERIBIT_WS_URL` é…ç½®ï¼Œä¸è¦å†™æ­»ã€‚

### 2.2 Heartbeatï¼ˆä¿è¯è¿æ¥ç¨³å®šï¼‰

Deribit æ”¯æŒ `public/set_heartbeat`ï¼Œå¦‚æœæ”¶åˆ° `test_request`ï¼Œéœ€è¦è°ƒç”¨ `/api/v2/public/test`ï¼ˆåœ¨ WS JSON-RPC ä¸‹å¯¹åº” `public/test` æ–¹æ³•ï¼‰æ¥å“åº”ã€‚([docs.deribit.com](https://docs.deribit.com/ "Deribit API"))

### 2.3 é¢‘é“ç­–ç•¥ï¼ˆé¿å…â€œdemo ç¿»è½¦â€ï¼‰

- Orderbookï¼š`book.<instrument>.100ms` æˆ– `book.<instrument>.<group>.<depth>.<interval>`  
  Deribit æ–‡æ¡£ç»™å‡ºäº† book çš„ snapshot/change ç»“æ„ä»¥åŠ interval å‚æ•°ã€‚([docs.deribit.com](https://docs.deribit.com/ "Deribit API"))

- Tradesï¼š`trades.<instrument>.100ms`ï¼ˆæ³¨æ„ `raw` å¯èƒ½éœ€è¦æˆæƒç”¨æˆ·ï¼Œdemo é»˜è®¤åˆ«ç”¨ rawï¼‰ã€‚([docs.deribit.com](https://docs.deribit.com/ "Deribit API"))

- Tickerï¼š`ticker.<instrument>.<interval>`ï¼ˆ100ms æˆ– agg2ï¼Œdemo é€‰ 100ms æ›´â€œåŠ¨â€ï¼‰

---

## 3) ç›®å½•ç»“æ„ï¼ˆä½ ç…§è¿™ä¸ªå»ºå°±è¡Œï¼‰

```text
deribit-ai-demo/
  docker-compose.yml
  .env.example

  services/
    api/
      Dockerfile
      requirements.txt
      app/
        main.py
        deribit_hub.py
        widgets.py

      static/
        index.html   # demo é¡µï¼ˆå¸¦è¾“å…¥æ¡† + iframeï¼‰

    builder/
      Dockerfile
      requirements.txt
      builder/
        main.py          # FastAPI æ¥æ”¶ build ä»»åŠ¡
        run_claude.py    # è°ƒ claude + pnpm build
      template/
        widget-template/ # React+Vite widget æ¨¡æ¿ï¼ˆç»™ Claude æ”¹ï¼‰

    mcp/
      Dockerfile
      requirements.txt
      mcp_server.py
```

---

## 4) docker-compose.ymlï¼ˆæ ¸å¿ƒï¼šå…±äº« widgets å· + å†…ç½‘äº’è”ï¼‰

```yaml
version: "3.9"

services:
  api:
    build: ./services/api
    environment:
      - DERIBIT_WS_URL=${DERIBIT_WS_URL}
      - BUILDER_URL=http://builder:8090
      - WIDGETS_DIR=/data/widgets
    ports:
      - "8080:8080"
    volumes:
      - ./data/widgets:/data/widgets
    depends_on:
      - builder

  builder:
    build: ./services/builder
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - MCP_URL=http://mcp:7001/mcp
      - WIDGETS_DIR=/data/widgets
    volumes:
      - ./data/widgets:/data/widgets
    depends_on:
      - mcp

  mcp:
    build: ./services/mcp
    environment:
      - DERIBIT_ENV=${DERIBIT_ENV:-prod}
    ports:
      - "7001:7001"
```

`.env.example`ï¼š

```bash
# Claude Codeï¼ˆCI/Headlessï¼‰ç”¨
ANTHROPIC_API_KEY=YOUR_KEY

# Deribitï¼šprod ç”¨ Event Nodes
DERIBIT_ENV=prod
DERIBIT_WS_URL=wss://streams.deribit.com/ws/api/v2

# å¦‚æœä½ è¦è·‘ testï¼š
# DERIBIT_ENV=test
# DERIBIT_WS_URL=wss://test.deribit.com/den/ws
```

---

## 5) API æœåŠ¡ï¼ˆFastAPIï¼šdemo é¡µ + widgets + /ws/market ç½‘å…³ï¼‰

### services/api/requirements.txt

```txt
fastapi==0.115.0
uvicorn[standard]==0.30.6
websockets==13.0
httpx==0.27.2
jinja2==3.1.4
```

### services/api/Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app ./app
COPY static ./static

ENV PYTHONUNBUFFERED=1
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8080"]
```

### services/api/app/main.py

```python
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse
from .deribit_hub import MarketHub
from .widgets import router as widgets_router

app = FastAPI(title="Deribit AI Demo")

hub = MarketHub()

@app.on_event("startup")
async def _startup():
    await hub.start()

@app.on_event("shutdown")
async def _shutdown():
    await hub.stop()

@app.get("/")
def index():
    return FileResponse("static/index.html")

# demo ç”Ÿæˆçš„ widget é™æ€èµ„æº
# /widgets/<id>/index.html ç”± Vite build è¾“å‡º
app.mount("/widgets", StaticFiles(directory="/data/widgets", html=True), name="widgets")

# ä¸šåŠ¡ APIï¼šåˆ›å»º widgetã€æŸ¥è¯¢çŠ¶æ€ç­‰
app.include_router(widgets_router, prefix="/api")

# WebSocketï¼šæµè§ˆå™¨ widget é€šè¿‡å®ƒè®¢é˜…å®æ—¶è¡Œæƒ…
app.add_api_websocket_route("/ws/market", hub.ws_handler)
```

### services/api/app/deribit_hub.pyï¼ˆæ ¸å¿ƒï¼šå•è¿æ¥æ‰‡å‡º + å¿ƒè·³ + åŠ¨æ€è®¢é˜…ï¼‰

```python
import asyncio
import json
import os
import re
from typing import Dict, Set
import websockets
from fastapi import WebSocket, WebSocketDisconnect

DERIBIT_WS_URL = os.getenv("DERIBIT_WS_URL", "wss://streams.deribit.com/ws/api/v2")

# åªå…è®¸å…¬å…±è®¢é˜…é¢‘é“ï¼ˆä½ å¯ä»¥æŒ‰éœ€æ‰©å±•ç™½åå•ï¼‰
ALLOWED_PREFIXES = (
    "ticker.",
    "book.",
    "trades.",
    "chart.trades.",
    "deribit_price_index.",
)

CHANNEL_RE = re.compile(r"^[a-zA-Z0-9_.\-]+$")


class MarketHub:
    def __init__(self):
        self._ws = None
        self._recv_task: asyncio.Task | None = None
        self._lock = asyncio.Lock()

        # channel -> set(WebSocket clients)
        self._subs: Dict[str, Set[WebSocket]] = {}
        self._all_channels: Set[str] = set()

        self._req_id = 1
        self._running = False

    async def start(self):
        self._running = True
        await self._connect()
        self._recv_task = asyncio.create_task(self._recv_loop())

    async def stop(self):
        self._running = False
        if self._recv_task:
            self._recv_task.cancel()
        if self._ws:
            await self._ws.close()

    def _next_id(self) -> int:
        self._req_id += 1
        return self._req_id

    async def _connect(self):
        self._ws = await websockets.connect(DERIBIT_WS_URL, ping_interval=None)
        # set heartbeat interval 30s
        await self._ws.send(json.dumps({
            "jsonrpc": "2.0",
            "id": self._next_id(),
            "method": "public/set_heartbeat",
            "params": {"interval": 30}
        }))

        # resubscribe all channels after reconnect
        if self._all_channels:
            await self._ws.send(json.dumps({
                "jsonrpc": "2.0",
                "id": self._next_id(),
                "method": "public/subscribe",
                "params": {"channels": sorted(self._all_channels)}
            }))

    async def _recv_loop(self):
        while self._running:
            try:
                raw = await self._ws.recv()
                msg = json.loads(raw)

                # heartbeat handling
                if msg.get("method") == "heartbeat":
                    params = msg.get("params") or {}
                    if params.get("type") == "test_request":
                        # respond with public/test
                        await self._ws.send(json.dumps({
                            "jsonrpc": "2.0",
                            "id": self._next_id(),
                            "method": "public/test",
                            "params": {}
                        }))
                    continue

                # subscription data
                if msg.get("method") == "subscription":
                    params = msg.get("params") or {}
                    channel = params.get("channel")
                    if not channel:
                        continue
                    # fan-out to clients subscribed to that channel
                    clients = self._subs.get(channel, set()).copy()
                    for client in clients:
                        try:
                            await client.send_text(raw)
                        except Exception:
                            pass
            except Exception:
                # reconnect loop
                await asyncio.sleep(1.0)
                try:
                    await self._connect()
                except Exception:
                    await asyncio.sleep(2.0)

    def _validate_channel(self, channel: str) -> bool:
        if not channel or not CHANNEL_RE.match(channel):
            return False
        if not channel.startswith(ALLOWED_PREFIXES):
            return False
        return True

    async def _subscribe_deribit(self, channels: Set[str]):
        if not channels:
            return
        await self._ws.send(json.dumps({
            "jsonrpc": "2.0",
            "id": self._next_id(),
            "method": "public/subscribe",
            "params": {"channels": sorted(channels)}
        }))

    async def _unsubscribe_deribit(self, channels: Set[str]):
        if not channels:
            return
        await self._ws.send(json.dumps({
            "jsonrpc": "2.0",
            "id": self._next_id(),
            "method": "public/unsubscribe",
            "params": {"channels": sorted(channels)}
        }))

    async def ws_handler(self, ws: WebSocket):
        await ws.accept()
        try:
            while True:
                data = await ws.receive_text()
                req = json.loads(data)

                op = req.get("op")
                channels = req.get("channels") or []
                channels = [c for c in channels if isinstance(c, str)]

                valid = [c for c in channels if self._validate_channel(c)]
                if not valid:
                    await ws.send_text(json.dumps({"type": "error", "error": "no valid channels"}))
                    continue

                async with self._lock:
                    if op == "subscribe":
                        newly_added = set()
                        for c in valid:
                            self._subs.setdefault(c, set()).add(ws)
                            if c not in self._all_channels:
                                self._all_channels.add(c)
                                newly_added.add(c)
                        await self._subscribe_deribit(newly_added)
                        await ws.send_text(json.dumps({"type": "ok", "op": "subscribe", "channels": valid}))

                    elif op == "unsubscribe":
                        newly_removed = set()
                        for c in valid:
                            if c in self._subs:
                                self._subs[c].discard(ws)
                                if not self._subs[c]:
                                    self._subs.pop(c, None)
                                    if c in self._all_channels:
                                        self._all_channels.remove(c)
                                        newly_removed.add(c)
                        await self._unsubscribe_deribit(newly_removed)
                        await ws.send_text(json.dumps({"type": "ok", "op": "unsubscribe", "channels": valid}))

                    else:
                        await ws.send_text(json.dumps({"type": "error", "error": "unknown op"}))

        except WebSocketDisconnect:
            pass
        finally:
            # cleanup: remove ws from all channels
            async with self._lock:
                removed = set()
                for c, clients in list(self._subs.items()):
                    if ws in clients:
                        clients.discard(ws)
                        if not clients:
                            self._subs.pop(c, None)
                            if c in self._all_channels:
                                self._all_channels.remove(c)
                                removed.add(c)
                await self._unsubscribe_deribit(removed)
```

### services/api/app/widgets.pyï¼ˆåˆ›å»º widget å¹¶è§¦å‘ builderï¼‰

```python
import os
import json
import uuid
import httpx
from fastapi import APIRouter
from pydantic import BaseModel

BUILDER_URL = os.getenv("BUILDER_URL", "http://builder:8090")
WIDGETS_DIR = os.getenv("WIDGETS_DIR", "/data/widgets")

router = APIRouter()

class CreateWidgetReq(BaseModel):
    prompt: str
    # ä½ ä¹Ÿå¯ä»¥åŠ  instrument / theme ç­‰å‚æ•°ï¼Œè®© demo æ›´åƒâ€œäº§å“â€
    instrument: str | None = None

@router.post("/widgets")
async def create_widget(req: CreateWidgetReq):
    wid = str(uuid.uuid4())[:8]
    out_dir = os.path.join(WIDGETS_DIR, wid)
    os.makedirs(out_dir, exist_ok=True)

    meta = {
        "id": wid,
        "prompt": req.prompt,
        "instrument": req.instrument or "BTC-PERPETUAL",
        "status": "queued",
    }
    with open(os.path.join(out_dir, "meta.json"), "w", encoding="utf-8") as f:
        json.dump(meta, f, ensure_ascii=False, indent=2)

    async with httpx.AsyncClient(timeout=5.0) as client:
        await client.post(f"{BUILDER_URL}/build", json={"id": wid, "prompt": req.prompt, "instrument": meta["instrument"]})

    return {
        "id": wid,
        "widget_url": f"/widgets/{wid}/dist/index.html?instrument={meta['instrument']}",
    }
```

---

## 6) Builder æœåŠ¡ï¼ˆClaude Code çœŸæ­£â€œæ”¾å¼€æ‰‹è„šâ€çš„åœ°æ–¹ï¼‰

### 6.1 ä¸ºä»€ä¹ˆè¿™å¥— builder ä¸ä¼šæŠŠä½ é”æ­»åœ¨â€œå›ºå®šç»„ä»¶â€

ä½ ç»™ Claude çš„ä¸æ˜¯ç»„ä»¶åˆ—è¡¨ï¼Œè€Œæ˜¯ï¼š

- **ä¸€ä¸ªå¯è¿è¡Œçš„ widget å·¥ç¨‹ï¼ˆæ¨¡æ¿ï¼‰**

- **ä¸€ä¸ªé€šç”¨æ•°æ®è®¢é˜… SDKï¼ˆsrc/lib/market.tsï¼‰**

- **ä¸€äº›å¯é€‰çš„ UI åŸè¯­ï¼ˆCard/Table/Kpiï¼‰**

- **æ˜ç¡®çš„çº¦æŸï¼ˆä¸è¦å‡ºå·¥ç¨‹è¾¹ç•Œã€ä¸è¦ä¹±è£…åŒ…ã€åªç”¨ /ws/market å®æ—¶æ•°æ®ï¼‰**

å®ƒå¯ä»¥è‡ªç”±æ”¹é¡µé¢ç»“æ„ã€å›¾è¡¨ã€å¸ƒå±€ã€äº¤äº’æ–¹å¼ï¼Œæœ¬è´¨æ˜¯â€œåœ¨é€šç”¨å·¥ç¨‹é‡Œåšäº§å“çº§å‰ç«¯â€ï¼Œä¸ä¼šå˜æˆä¸‹æ‹‰æ¡†é€‰ç»„ä»¶ã€‚

### services/builder/requirements.txt

```txt
fastapi==0.115.0
uvicorn[standard]==0.30.6
```

### services/builder/Dockerfile

```dockerfile
FROM node:24-bookworm-slim

WORKDIR /app

# python + git
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-pip git ca-certificates curl \
  && rm -rf /var/lib/apt/lists/*

# pnpm + claude-codeï¼ˆå®˜æ–¹æ–‡æ¡£ç»™å‡º npm å®‰è£…æ–¹å¼ï¼‰ 
# npm install -g @anthropic-ai/claude-code :contentReference[oaicite:7]{index=7}
RUN npm install -g pnpm @anthropic-ai/claude-code

COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

COPY builder ./builder
COPY template ./template

ENV PYTHONUNBUFFERED=1
CMD ["uvicorn", "builder.main:app", "--host", "0.0.0.0", "--port", "8090"]
```

### services/builder/builder/main.py

```python
import os
import json
from fastapi import FastAPI
from pydantic import BaseModel
from .run_claude import build_widget

WIDGETS_DIR = os.getenv("WIDGETS_DIR", "/data/widgets")

app = FastAPI(title="Widget Builder")

class BuildReq(BaseModel):
    id: str
    prompt: str
    instrument: str

@app.post("/build")
def build(req: BuildReq):
    # åŒæ­¥ demo å¤Ÿç”¨ï¼›è¦å¹¶å‘å¯æ”¹æˆåå°ä»»åŠ¡é˜Ÿåˆ—
    build_widget(req.id, req.prompt, req.instrument, WIDGETS_DIR)
    return {"ok": True}
```

### services/builder/builder/run_claude.pyï¼ˆæ ¸å¿ƒï¼šclaude mcp add + claude -p + pnpm buildï¼‰

```python
import os
import shutil
import subprocess
import json
from pathlib import Path

TEMPLATE_DIR = Path("/app/template/widget-template")
MCP_URL = os.getenv("MCP_URL", "http://mcp:7001/mcp")

def _run(cmd: list[str], cwd: Path | None = None, env: dict | None = None):
    p = subprocess.run(cmd, cwd=str(cwd) if cwd else None, env=env, check=True, capture_output=True, text=True)
    return p.stdout

def build_widget(widget_id: str, user_prompt: str, instrument: str, widgets_dir: str):
    out_root = Path(widgets_dir) / widget_id
    ws_dir = out_root / "workspace"
    dist_dir = out_root / "dist"

    if ws_dir.exists():
        shutil.rmtree(ws_dir)
    shutil.copytree(TEMPLATE_DIR, ws_dir)

    # ç»™ Claude çš„é¡¹ç›®è¯´æ˜ï¼ˆéå¸¸å…³é”®ï¼šè®©å®ƒâ€œè‡ªç”±ä½†ä¸ä¹±è·‘â€ï¼‰
    claude_md = ws_dir / "CLAUDE.md"
    claude_md.write_text(f"""# Widget Project Rules

You are editing a self-contained widget (React + Vite + TS).
Goal: implement the requested widget UI for Deribit market data.

## Constraints
- Do NOT fetch Deribit directly from browser. Use src/lib/market.ts (connects to /ws/market).
- Keep dependencies minimal. Prefer existing deps.
- The widget must build with: pnpm install && pnpm run build
- The widget must read instrument from query param ?instrument=... (default {instrument})
- The widget should fit in an iframe and be responsive.

## Data subscription
Use market.subscribe([...channels]) where channels follow Deribit public channels.
Common channels:
- ticker.<instrument>.100ms
- book.<instrument>.100ms or book.<instrument>.<group>.<depth>.<interval>
- trades.<instrument>.100ms
- chart.trades.<instrument>.<resolution>

You have an MCP tool server named `deribit` to help list instruments and channel formats.
""", encoding="utf-8")

    # å…ˆæŠŠ MCP server é…å¥½ï¼ˆClaude Code å®˜æ–¹ç»™å‡º mcp add çš„è¯­æ³•ï¼‰:contentReference[oaicite:8]{index=8}
    try:
        _run(["claude", "mcp", "add", "--transport", "http", "deribit", MCP_URL], cwd=ws_dir)
    except Exception:
        # å·²å­˜åœ¨å°±å¿½ç•¥
        pass

    prompt = f"""Build a widget per this request:

User request:
{user_prompt}

Instrument:
{instrument}

Deliverables:
- Update src/App.tsx (or create components) to implement the UI.
- Subscribe to appropriate channels via src/lib/market.ts.
- Ensure pnpm run build passes.
"""

    env = os.environ.copy()
    # Claude Code åœ¨ CI ç¤ºä¾‹ä¸­è¯´æ˜ä¼šä»ç¯å¢ƒå˜é‡ä½¿ç”¨ ANTHROPIC_API_KEY :contentReference[oaicite:9]{index=9}

    # Headless ç”¨æ³•ï¼š-p + permission-mode + allowedToolsï¼ˆå®˜æ–¹ headless æ–‡æ¡£ï¼‰:contentReference[oaicite:10]{index=10}
    _run([
        "claude",
        "-p", prompt,
        "--permission-mode", "acceptEdits",
        "--allowedTools", "Bash(*) Read(*) Edit(*) Write(*) mcp__deribit",
        "--output-format", "json"
    ], cwd=ws_dir, env=env)

    _run(["pnpm", "install", "--frozen-lockfile"], cwd=ws_dir, env=env)
    _run(["pnpm", "run", "build"], cwd=ws_dir, env=env)

    # Vite dist è¾“å‡º
    built = ws_dir / "dist"
    if dist_dir.exists():
        shutil.rmtree(dist_dir)
    shutil.copytree(built, dist_dir)

    # æ ‡è®°å®Œæˆ
    meta_path = out_root / "meta.json"
    if meta_path.exists():
        meta = json.loads(meta_path.read_text(encoding="utf-8"))
        meta["status"] = "ready"
        meta_path.write_text(json.dumps(meta, ensure_ascii=False, indent=2), encoding="utf-8")
```

---

## 7) Widget æ¨¡æ¿ï¼ˆç»™ Claude â€œæ— é™å‘æŒ¥â€çš„åœ°åŸºï¼‰

ä½ åªéœ€è¦ä¿è¯ä¸¤ç‚¹ï¼š

1. æ¨¡æ¿èƒ½ä¸€é”® build

2. æ¨¡æ¿å†…ç½® `market.ts`ï¼Œè®©å®ƒè®¢é˜…é¢‘é“å°±èƒ½æ‹¿åˆ°å®æ—¶æ•°æ®

### services/builder/template/widget-template/package.json

```json
{
  "name": "deribit-widget",
  "private": true,
  "version": "0.0.1",
  "type": "module",
  "scripts": {
    "dev": "vite --host 0.0.0.0 --port 5173",
    "build": "tsc -b && vite build",
    "preview": "vite preview --host 0.0.0.0 --port 4173"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1"
  },
  "devDependencies": {
    "@types/react": "^18.3.5",
    "@types/react-dom": "^18.3.0",
    "typescript": "^5.5.4",
    "vite": "^5.4.2"
  }
}
```

### services/builder/template/widget-template/vite.config.ts

```ts
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
  base: "./"
});
```

### services/builder/template/widget-template/src/lib/market.ts

```ts
type Handler = (msg: any) => void;

export class MarketClient {
  private ws: WebSocket | null = null;
  private handlers: Map<string, Set<Handler>> = new Map();

  connect() {
    if (this.ws && (this.ws.readyState === WebSocket.OPEN || this.ws.readyState === WebSocket.CONNECTING)) return;

    const proto = location.protocol === "https:" ? "wss" : "ws";
    const url = `${proto}://${location.host}/ws/market`;
    this.ws = new WebSocket(url);

    this.ws.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        // Deribit subscription payload shape passthrough:
        // { jsonrpc:"2.0", method:"subscription", params:{ channel, data } }
        const ch = msg?.params?.channel;
        if (!ch) return;
        const hs = this.handlers.get(ch);
        if (hs) hs.forEach((h) => h(msg));
      } catch {}
    };
  }

  subscribe(channels: string[], handler: Handler) {
    this.connect();
    channels.forEach((c) => {
      if (!this.handlers.has(c)) this.handlers.set(c, new Set());
      this.handlers.get(c)!.add(handler);
    });
    this.ws?.send(JSON.stringify({ op: "subscribe", channels }));
  }

  unsubscribe(channels: string[], handler: Handler) {
    channels.forEach((c) => {
      this.handlers.get(c)?.delete(handler);
    });
    this.ws?.send(JSON.stringify({ op: "unsubscribe", channels }));
  }
}

export const market = new MarketClient();
```

### services/builder/template/widget-template/src/App.tsxï¼ˆåˆå§‹å¾ˆç®€å•ï¼ŒClaude ä¼šæŒ‰éœ€æ”¹ï¼‰

```tsx
import React, { useEffect, useMemo, useState } from "react";
import { market } from "./lib/market";

function getInstrument() {
  const p = new URLSearchParams(location.search);
  return p.get("instrument") || "BTC-PERPETUAL";
}

export default function App() {
  const instrument = useMemo(() => getInstrument(), []);
  const [last, setLast] = useState<number | null>(null);

  useEffect(() => {
    const ch = `ticker.${instrument}.100ms`;
    const handler = (msg: any) => {
      const data = msg?.params?.data;
      if (data?.last_price) setLast(data.last_price);
    };
    market.subscribe([ch], handler);
    return () => market.unsubscribe([ch], handler);
  }, [instrument]);

  return (
    <div style={{ fontFamily: "system-ui", padding: 12 }}>
      <div style={{ fontSize: 12, opacity: 0.7 }}>Instrument</div>
      <div style={{ fontSize: 18, fontWeight: 600 }}>{instrument}</div>
      <div style={{ marginTop: 12, fontSize: 12, opacity: 0.7 }}>Last Price</div>
      <div style={{ fontSize: 28, fontWeight: 700 }}>{last ?? "--"}</div>
    </div>
  );
}
```

---

## 8) MCP æœåŠ¡ï¼ˆç»™ Claude â€œæŸ¥ instrument / æ‹¼é¢‘é“ / é¢‘é“é€ŸæŸ¥â€ï¼‰

è¿™é‡Œç”¨ **FastMCP** åšä¸€ä¸ª HTTP MCP serverï¼ˆ`mcp.run(transport="http", ... path="/mcp")` è¿™ç±»å†™æ³•åœ¨ FastMCP æ–‡æ¡£ä¸ä»“åº“é‡Œæœ‰ç¤ºä¾‹ï¼‰ã€‚([GitHub](https://github.com/jlowin/fastmcp?utm_source=chatgpt.com "jlowin/fastmcp: ğŸš€ The fast, Pythonic way to build MCP ..."))  
Claude Code ä¾§ç”¨ `claude mcp add --transport http ...` è¿æ¥ã€‚([Claude Code](https://code.claude.com/docs/en/mcp "Connect Claude Code to tools via MCP - Claude Code Docs"))

### services/mcp/requirements.txt

```txt
fastmcp==2.2.0
ccxt==4.4.0
```

### services/mcp/Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY mcp_server.py .

CMD ["python", "mcp_server.py"]
```

### services/mcp/mcp_server.py

```python
import os
from fastmcp import FastMCP
import ccxt

DERIBIT_ENV = os.getenv("DERIBIT_ENV", "prod")

mcp = FastMCP("deribit-tools")

def _exchange():
    # ccxt çš„ deribitï¼šç”¨äºåˆ—å¸‚åœº/åˆçº¦åï¼ˆdemo è¶³å¤Ÿï¼‰
    ex = ccxt.deribit({"enableRateLimit": True})
    return ex

@mcp.tool
def list_instruments(query: str = "", kind: str = "future", limit: int = 20):
    """
    List Deribit instruments (best-effort via ccxt). Returns a list of instrument symbols/names.
    """
    ex = _exchange()
    markets = ex.load_markets()
    names = []
    for k, v in markets.items():
        # v["type"] might exist; keep it best-effort
        s = v.get("symbol") or k
        if query.lower() in s.lower():
            names.append(s)
    return names[:limit]

@mcp.tool
def channel_cheatsheet():
    """
    Quick reference for common public subscription channels.
    """
    return {
        "ticker": "ticker.<instrument>.<interval>  interval: 100ms|agg2|raw",
        "book": "book.<instrument>.100ms OR book.<instrument>.<group>.<depth>.<interval>",
        "trades": "trades.<instrument>.<interval>  interval: agg2|100ms|raw (raw may require authorization)",
        "chart": "chart.trades.<instrument>.<resolution>  resolution: 1,3,5,10,...",
        "notes": [
            "Prefer interval=100ms for demo vividness.",
            "Use grouped book for depth ladders."
        ]
    }

if __name__ == "__main__":
    # Streamable HTTP MCP endpoint at http://0.0.0.0:7001/mcp
    mcp.run(transport="http", host="0.0.0.0", port=7001, path="/mcp")
```

---

## 9) Demo é¡µï¼ˆæœ€ç®€å•ï¼šè¾“å…¥ prompt â†’ ç”Ÿæˆ â†’ iframe å±•ç¤ºï¼‰

### services/api/static/index.html

```html
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Deribit AI Widget Demo</title>
    <style>
      body { font-family: system-ui; margin: 16px; }
      .row { display: flex; gap: 12px; }
      textarea { width: 520px; height: 120px; }
      iframe { width: 520px; height: 360px; border: 1px solid #ddd; }
    </style>
  </head>
  <body>
    <h2>Deribit AI Widget Demo</h2>

    <div class="row">
      <div>
        <div>Prompt</div>
        <textarea id="prompt">åšä¸€ä¸ª BTC-PERPETUAL çš„å®æ—¶è¡Œæƒ…å¡ç‰‡ï¼šæ˜¾ç¤º last/mark/index priceã€24h å˜åŠ¨ã€å¹¶ç”»ä¸€ä¸ªæœ€è¿‘ 60 ä¸ªç‚¹çš„è¿·ä½ æŠ˜çº¿å›¾ã€‚</textarea>
        <div style="margin-top:8px;">
          <label>Instrument: </label>
          <input id="instrument" value="BTC-PERPETUAL" />
          <button id="go">Generate</button>
        </div>
        <div id="out" style="margin-top:10px; font-size:12px; opacity:0.8;"></div>
      </div>

      <div>
        <div>Widget Preview (iframe)</div>
        <iframe id="frame" sandbox="allow-scripts allow-same-origin"></iframe>
      </div>
    </div>

    <script>
      const out = document.getElementById("out");
      const frame = document.getElementById("frame");

      document.getElementById("go").onclick = async () => {
        out.textContent = "building...";
        const prompt = document.getElementById("prompt").value;
        const instrument = document.getElementById("instrument").value;

        const r = await fetch("/api/widgets", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({prompt, instrument})
        });
        const j = await r.json();
        out.textContent = `widget id=${j.id}, url=${j.widget_url}`;

        frame.src = j.widget_url;
      };
    </script>
  </body>
</html>
```

---

## 10) å¯åŠ¨æ–¹å¼ï¼ˆä½ ç»™é”€å”®æ¼”ç¤ºçš„æœ€çŸ­è·¯å¾„ï¼‰

```bash
cd deribit-ai-demo
cp .env.example .env
# å¡«å¥½ ANTHROPIC_API_KEY
docker-compose up --build
```

æ‰“å¼€ï¼š

- `http://localhost:8080/`

ç„¶ååœ¨ prompt é‡Œéšä¾¿æ¢æˆï¼š

- â€œåšä¸€ä¸ª orderbook æ·±åº¦æ¢¯å½¢å›¾ï¼šå±•ç¤º top 10 bids/asksï¼Œä»·æ ¼æŒ‰æ¡£ä½å¯¹é½â€

- â€œåšä¸€ä¸ªå®æ—¶ trades åˆ—è¡¨ï¼šæœ€è¿‘ 30 æ¡ï¼ŒæŒ‰æ–¹å‘é«˜äº®ï¼Œå¹¶å¸¦ç»Ÿè®¡ï¼ˆæœ€è¿‘ 1 åˆ†é’Ÿæˆäº¤ç¬”æ•°ï¼‰â€

- â€œåšä¸€ä¸ª funding/mark/last çš„ä¸‰è¡Œ KPI é¢æ¿ + çŠ¶æ€ç¯ï¼ˆæ•°æ®å»¶è¿Ÿ>2s å˜é»„ï¼‰â€

è¿™ç±»éœ€æ±‚éƒ½ä¼šè¿«ä½¿å®ƒï¼š

1. é€‰æ‹©é¢‘é“ï¼ˆticker/book/trades/chartï¼‰

2. å†™çŠ¶æ€ç®¡ç†å’Œæ•°æ®ç»“æ„

3. å†™ UIï¼ˆè¡¨æ ¼ã€å›¾è¡¨ã€å¸ƒå±€ï¼‰

4. build å¹¶åœ¨ iframe é‡Œè·‘èµ·æ¥ï¼ˆå®æ—¶åˆ·æ–°ï¼‰

---

## 11) é£é™©ä¸åŠ å›ºï¼ˆä¸å½±å“ demoï¼Œä½†å»ºè®®ä½ è‡³å°‘åšä¸¤æ¡ï¼‰

1. **é™åˆ¶å¯è®¢é˜…é¢‘é“ç™½åå•**ï¼šæˆ‘åœ¨ `api` é‡Œå·²ç»åšäº†å‰ç¼€ç™½åå•ä¸å­—ç¬¦æ ¡éªŒï¼Œé¿å…è¢«â€œä¼ªé€  method/è·¯å¾„â€åˆ©ç”¨ã€‚

2. **é»˜è®¤åˆ«ç”¨ trades raw**ï¼šDeribit æ–‡æ¡£æç¤º raw interval å¯èƒ½ä»…å¯¹æˆæƒç”¨æˆ·å¼€æ”¾ï¼Œdemo ç”¨ `100ms` æ›´ç¨³ã€‚([docs.deribit.com](https://docs.deribit.com/ "Deribit API"))

3. **builder éš”ç¦»**ï¼šçœŸæ­£è¦é•¿æœŸè·‘ï¼Œå»ºè®®æŠŠ builder åšæˆä¸€æ¬¡æ€§ job å®¹å™¨æˆ–åŠ é˜Ÿåˆ—ï¼›demo é˜¶æ®µå…ˆä¸å¤æ‚åŒ–ã€‚

---

## 12) â€œccxtâ€çš„ä½ç½®æ€ä¹ˆæ”¾

- **å…ƒæ•°æ®/å¸‚åœºåˆ—è¡¨**ï¼šccxt å¾ˆé€‚åˆç»™ Claude å½“å·¥å…·ç”¨ï¼ˆMCP é‡Œ list/search instrumentï¼‰ã€‚

---

å¦‚æœä½ æ„¿æ„æŠŠ demo å†â€œäº§å“åŒ–â€ä¸€ç‚¹ï¼ˆæ›´æ‰“åŠ¨é”€å”®ï¼‰ï¼Œä¸‹ä¸€æ­¥æˆ‘å»ºè®®ä½ åŠ  3 ä¸ªéå¸¸å°ä½†å¾ˆæœ‰æ•ˆçš„å¢å¼ºï¼ˆä¸æ”¹å˜æ•´ä½“æ¶æ„ï¼‰ï¼š

1. `api` å¢åŠ  `/api/widgets/<id>/logs`ï¼ˆbuilder æŠŠ claude è¾“å‡º + pnpm build æ—¥å¿—å†™æ–‡ä»¶ï¼‰ï¼Œdemo é¡µå¯å®æ—¶æ˜¾ç¤ºâ€œAI æ­£åœ¨åšä»€ä¹ˆâ€

2. widget æ¨¡æ¿å¢åŠ  2~3 ä¸ªæé€šç”¨ UI åŸè¯­ï¼ˆCard/Table/Sparklineï¼‰ï¼Œè®© Claude è¾“å‡ºæ›´ç¨³å®šã€æ›´åƒä½ ä»¬æœªæ¥ç»„ä»¶ä½“ç³»

3. `mcp` å¢åŠ ä¸€ä¸ª `recommend_channels(requirement_text)` å·¥å…·ï¼šæŠŠâ€œç”¨æˆ·æƒ³è¦çš„ UIâ€æ˜ å°„åˆ°é¢‘é“é›†åˆï¼Œå‡å°‘å®ƒé€‰é”™é¢‘é“å¯¼è‡´çš„å¤±è´¥
